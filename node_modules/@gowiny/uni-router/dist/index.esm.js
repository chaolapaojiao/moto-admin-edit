/**
  * gowiny-uni-router v1.0.15
  * https://gitee.com/gowiny/uni-router
  *
  * (c) 2022-present gowiny
  * @license MIT
  *
  * Date: 2022-12-30T04:57:01Z
  */
import{isString,isObject,queueInvoke,isNumber,invoke}from"@gowiny/js-utils";import qs from"qs";const UniLifecycleHooks={INIT:"onInit",LOAD:"onLoad",SHOW:"onShow",READY:"onReady"},StaticContext={navLock:!1,beforeEachLock:!1,firstRequestState:"not",firstRequestListeners:[],handleFirstRequestResult(t){StaticContext.firstRequestListeners.forEach((e=>{e.success(t)})),StaticContext.firstRequestListeners=[]},app:void 0,route:void 0,toRoute:void 0,fromRoute:void 0,router:void 0};function getRouteByPage(t){let e=t.route||"";e.startsWith("/")||(e="/"+e);return{fullPath:e,path:e}}function warn(t,...e){const o=t.options.debugger;o&&(!0===o||o.info)&&console.warn(...e)}function getCurrentPagePath(){const t=getCurrentPage();return t&&t.route?"/"+t.route:void 0}function getCurrentPage(){const t=getCurrentPages();return t.length>0?t[t.length-1]:void 0}function getRouteByPath(t,e,o,a){a=a||formatFullPath(e,o);const r=e.replace(/^\//,""),n=t.routeMap.pathMap[r];let i;return i=n?{...n,fullPath:a,path:e,query:o}:{fullPath:a,path:e,query:o},i}function getRouteByUrl(t,e){const o=t.indexOf("?");let a,r;o>-1?(r=t.substring(0,o),a=t.substring(o+1)):(r=t,a="");const n=a?qs.parse(a):{},i=r.replace(/^\//,""),c=e.routeMap.pathMap[i];let u;return u=c?{...c,fullPath:t,path:r,query:n}:{fullPath:t,path:r,query:n},u}function formatFullPath(t,e){const o=qs.stringify(e);return o?`${t}?${o}`:t}function lockNavjump(t,e,o,a=!1){const r={};if(isString(t))r.url=t;else{const o=t;let a,n=o.query;if(o.name){a=e.routeMap.nameMap[o.name].path}else a=o.path,n=o.query;const i=formatFullPath(a,n),c={...o};delete c.name,delete c.path,delete c.query,Object.assign(r,c),r.url=i}let n;switch(r.$force=a,o){case"push":n=uni.navigateTo(r);break;case"replace":n=uni.redirectTo(r);break;case"pushTab":n=uni.switchTab(r);break;case"replaceAll":n=uni.reLaunch(r);break;default:throw new Error("\u8def\u7531\u7c7b\u578b\u4e0d\u6b63\u786e")}return n}function appendPages(t,e,o){o.forEach((o=>{const a=o.path,r=a.startsWith("/")?a:"/"+a,n={...o,path:r};e[r]=n,t.push(n)}))}function parseRoutesFromPages({pages:t,subPackages:e=[]}){const o=[],a={};return appendPages(o,a,t),e.forEach((t=>{appendPages(o,a,t.pages)})),o}async function callEachHooks(t,e,o,a){let r=t.lifeCycleHooks[e];return await queueInvoke(r,null,[o,a],(t=>!1!==t&&!isObject(t)))}async function invokeAfterEach(t,e,o){return await callEachHooks(t,"ae",e,o)}async function invokeBeforeEach(t,e,o){StaticContext.beforeEachLock=!0;try{const a=await callEachHooks(t,"be",e,o);if(!0===a||null==a)return!0;if(!1!==a){let e,o="push";if(isString(a))e={path:a},o="push";else if(isObject(a)){const t=a;e=t.to,o=t.navType}e&&lockNavjump(e,t,o,!0)}return!1}finally{StaticContext.beforeEachLock=!1}}let IS_WAPPED=!1;const METHOD_NAME_NAVIGATE_TO="navigateTo",METHOD_NAME_REDIRECT_TO="redirectTo",METHOD_NAME_RELAUNCH="reLaunch",METHOD_NAME_SWITCH_TAB="switchTab",METHOD_NAME_NAVIGATE_BACK="navigateBack",oldMethods={navigateTo:uni.navigateTo,redirectTo:uni.redirectTo,reLaunch:uni.reLaunch,switchTab:uni.switchTab,navigateBack:uni.navigateBack};function callOldMethod(t,e){const o=oldMethods[t];o&&o(e)}function callNavError(t,e,o){e.fail&&e.fail(o),e.complete&&e.complete(),t&&(StaticContext.navLock=!1)}function callNavSuccess(t,e){callOldMethod(t,{...e,async success(...t){try{e.success&&await e.success(...t)}finally{StaticContext.route=StaticContext.toRoute,StaticContext.lastFullPath=StaticContext.route?StaticContext.route.fullPath:void 0,StaticContext.router&&StaticContext.toRoute&&(StaticContext.router.route=StaticContext.route,await invokeAfterEach(StaticContext.router,StaticContext.toRoute,StaticContext.fromRoute)),StaticContext.navLock=!1}},async fail(...t){try{console.error(t&&t[0]?t[0].errMsg:""),e.fail&&await e.fail(...t)}finally{StaticContext.navLock=!1}},complete(...t){e.complete&&e.complete(...t)}})}function createWapper(t){return async function(e){if((StaticContext.navLock||StaticContext.beforeEachLock)&&!e.$force)return StaticContext.router&&warn(StaticContext.router,"\u5f53\u524d\u9875\u9762\u6b63\u5728\u5904\u4e8e\u8df3\u8f6c\u72b6\u6001\uff0c\u8bf7\u7a0d\u540e\u518d\u8fdb\u884c\u8df3\u8f6c...."),callNavError(!1,e,"\u5f53\u524d\u9875\u9762\u6b63\u5728\u5904\u4e8e\u8df3\u8f6c\u72b6\u6001\uff0c\u8bf7\u7a0d\u540e\u518d\u8fdb\u884c\u8df3\u8f6c....");StaticContext.navLock=!0;try{if(!StaticContext.router)return callNavSuccess(t,e);const o=StaticContext.router;let a;if("navigateBack"==t){const t=isNumber(e.delta)?e.delta:1,r=getCurrentPages(),n=r.length-t-1;a=n<0?getRouteByUrl(o.indexRouteRule.path,o):getRouteByPage(r[n])}else{a=getRouteByUrl(e.url,o)}const r=StaticContext.route;StaticContext.toRoute=a,StaticContext.fromRoute=r,StaticContext.destFullPath=a.fullPath;return await invokeBeforeEach(o,a,r)?callNavSuccess(t,e):callNavError(!0,e,"\u8def\u7531\u5b88\u536b\u62e6\u622a")}catch(t){return callNavError(!0,e,t)}}}function addNavInterceptor(){IS_WAPPED||(IS_WAPPED=!0,uni.navigateTo=createWapper("navigateTo"),uni.redirectTo=createWapper("redirectTo"),uni.reLaunch=createWapper("reLaunch"),uni.switchTab=createWapper("switchTab"),uni.navigateBack=createWapper("navigateBack"))}const DEFAULT_PROXY_METHODS=[UniLifecycleHooks.INIT,UniLifecycleHooks.LOAD,UniLifecycleHooks.SHOW,UniLifecycleHooks.READY],MP_TYPE_PAGE="page";function getRouterData(t){return t.__routerData||(t.__routerData={}),t.__routerData}function getOriHookDataMap(t){const e=getRouterData(t);return e.oriHookDataMap||(e.oriHookDataMap={}),e.oriHookDataMap}function getOriHookData(t,e){const o=getOriHookDataMap(t);let a=o[e];return a||(a={oldVal:[]},o[e]=a),a}function invokeOriMethod(t,e,o){const a=(getRouterData(e).oldMethods||{})[t];if(a)return a.apply(e,o)}function invokeOriHooks(t,e,o){const a=getOriHookData(e,t);invoke(a.oldVal,e,o)}function saveOriRoute(t,e){getRouterData(t).oriRoute=e}function getOriRoute(t){const e=getRouterData(t);return e.oriRoute||(e.oriRoute={}),e.oriRoute}function saveCurrRouteByCurrPage(t,e,o={}){const a=getCurrentPage();if(!a||!a.route)return;const r="/"+a.route;saveOriRoute(e,{path:r,query:o});const n=getRouteByPath(t,r,o);t.route=n}function wapperMethod(t,e,o,a){return wapperFun(t,"method",e,o,a,invokeOriMethod)}async function wapperFun(t,e,o,a,r,n){const i=getRouterData(o);if(!0===(i.hookLock||!1)){i.hookListeners||(i.hookListeners=[]);const t=new Promise(((t,e)=>{i.hookListeners.push({success:t,fail:e})}));let e;return await t&&(e=n(a,o,r)),e}let c;i.hookLock=!0;try{const u=getCurrentPagePath();let s;if("hook"!==e||UniLifecycleHooks.INIT!=a&&UniLifecycleHooks.LOAD!=a)s=getOriRoute(o).query||{};else{s=r[0]||{};Object.keys(s).forEach((t=>{const e=s[t];e&&(s[t]=decodeURIComponent(e))})),saveOriRoute(o,{path:u,query:s})}let l=!0;if(u){const e=formatFullPath(u,s);if(StaticContext.destFullPath!=e){const o=getRouteByPath(t,u,s,e),a=StaticContext.route;StaticContext.toRoute=o,StaticContext.fromRoute=a,l=await invokeBeforeEach(t,o,a),l&&(StaticContext.route=o,t.route=o,StaticContext.lastFullPath=e,await invokeAfterEach(t,o,a))}}if(l&&(c=n(a,o,r)),i.hookListeners){const t=i.hookListeners;for(let e=0;e<t.length;e++){t[e].success(l)}i.hookListeners=[]}}catch(t){if(i.hookListeners){const e=i.hookListeners;for(let o=0;o<e.length;o++){e[o].fail(t)}i.hookListeners=[]}}return i.hookLock=!1,c}function wapperHook(t,e,o,a){return wapperFun(t,"hook",e,o,a,invokeOriHooks)}function wapperUniHooks(t,e,o){return function(...a){wapperHook(t,e,o,a)}}function appendRoutes(t,e,o="",a){if(!a||0==a.length)return;const r=e.pathMap,n=e.nameMap;a.forEach((a=>{const{alias:i,path:c,name:u}=a;if(null==c)throw new Error(`\u8bf7\u63d0\u4f9b\u4e00\u4e2a\u5b8c\u6574\u7684\u8def\u7531\u5bf9\u8c61\uff0c\u5305\u62ec\u4ee5\u7edd\u5bf9\u8def\u5f84\u5f00\u59cb\u7684 \u2018path\u2019 \u5b57\u7b26\u4e32 ${JSON.stringify(a)}`);if(r[o+c]=a,u&&(n[u]=a),i)if(Array.isArray(i))i.forEach((t=>{r[o+t]=a}));else{r[o+i]=a}appendRoutes(t,e,a.path,a.children)}))}function createRouteMap(t,e){const o={pathMap:Object.create(null),nameMap:Object.create(null)};return appendRoutes(t,o,"",e),o}function registerEachHooks(t,e,o){let a=t.lifeCycleHooks[e];a||(a=[],t.lifeCycleHooks[e]=a),a.push(o)}function isPageHook(t){return"page"===t.$mpType}class RouterImpl{proxyMode;proxyMethods;routes;indexRouteRule;lifeCycleHooks={};$locked=!1;options;routeMap;route;constructor(t){this.options=t,this.proxyMode=t.proxyMode||"hook",this.proxyMethods=t.proxyMethods||DEFAULT_PROXY_METHODS,this.routes=parseRoutesFromPages(t.pageData),this.indexRouteRule=this.routes[0],this.routeMap=createRouteMap(this,this.routes)}setupRouter(t){t.use(this)}push(t){return lockNavjump(t,this,"push")}replace(t){return lockNavjump(t,this,"replace")}replaceAll(t){return lockNavjump(t,this,"replaceAll")}pushTab(t){return lockNavjump(t,this,"pushTab")}back(...t){return uni.navigateBack(...t)}beforeEach(t){registerEachHooks(this,"be",t)}afterEach(t){registerEachHooks(this,"ae",t)}async install(t,...e){const o=this;let a;StaticContext.app=t,StaticContext.router=o,Object.defineProperty(t.config.globalProperties,"$Router",{get:()=>o}),Object.defineProperty(t.config.globalProperties,"$Route",{get:()=>o.route}),"hook"===o.proxyMode?a={beforeCreate(){if(!isPageHook(this))return;const t=this;o.proxyMethods.forEach((e=>{const a=getOriHookData(t,e),r=t.$[e]||[],n=Array.isArray(r)?r:[r];a.oldVal=n,a.wapper=wapperUniHooks(o,t,e);const i=[a.wapper],c=i;i.push=function(...t){return a.oldVal.push(...t),i.length},i.pop=function(){return a.oldVal.pop()},i.shift=function(){return a.oldVal.shift()},i.unshift=function(...t){return a.oldVal.unshift(...t),i.length},c.splice=function(...t){return a.oldVal.splice(...t)},i.reverse=function(){return a.oldVal.reverse()},i.sort=function(){return a.oldVal.sort()},a.newVal=i,Object.defineProperty(t.$,e,{get:()=>a.newVal,set(t){t!==a.newVal&&t!==a.wapper&&(t?Array.isArray(t)?t.indexOf(a.wapper)>-1?t.length>1&&t.forEach((t=>{t!==a.wapper&&a.oldVal.push(t)})):a.oldVal=t:a.oldVal=[t]:a.oldVal=[])}})}))}}:"method"===o.proxyMode&&(a={created(){if(!isPageHook(this))return;const t=this,e=getRouterData(t),a={};e.oldMethods=a,o.proxyMethods.forEach((e=>{const r=t[e];r?(a[e]=r,t[e]=(...a)=>wapperMethod(o,t,e,a)):console.warn(`\u6b64\u9875\u9762\u6ca1\u6709\u65b9\u6cd5:${e}`)}))},onInit(t){isPageHook(this)&&saveCurrRouteByCurrPage(o,this,t)},onLoad(t){isPageHook(this)&&saveCurrRouteByCurrPage(o,this,t)}}),a&&t.mixin(a),addNavInterceptor()}}function createRouter(t){return new RouterImpl(t)}export{UniLifecycleHooks,createRouter};