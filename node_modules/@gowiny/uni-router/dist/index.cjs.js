/**
  * gowiny-uni-router v1.0.15
  * https://gitee.com/gowiny/uni-router
  *
  * (c) 2022-present gowiny
  * @license MIT
  *
  * Date: 2022-12-30T04:57:01Z
  */
"use strict";var _oldMethods,_classCallCheck=require("@babel/runtime/helpers/classCallCheck"),_createClass=require("@babel/runtime/helpers/createClass"),_regeneratorRuntime=require("@babel/runtime/regenerator"),_toConsumableArray=require("@babel/runtime/helpers/toConsumableArray"),_asyncToGenerator=require("@babel/runtime/helpers/asyncToGenerator"),_defineProperty=require("@babel/runtime/helpers/defineProperty"),_typeof=require("@babel/runtime/helpers/typeof");function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}Object.defineProperty(exports,"__esModule",{value:!0});var jsUtils=require("@gowiny/js-utils"),qs=require("qs");function _interopDefaultLegacy(e){return e&&"object"===_typeof(e)&&"default"in e?e:{default:e}}var qs__default=_interopDefaultLegacy(qs),UniLifecycleHooks={INIT:"onInit",LOAD:"onLoad",SHOW:"onShow",READY:"onReady"},StaticContext={navLock:!1,beforeEachLock:!1,firstRequestState:"not",firstRequestListeners:[],handleFirstRequestResult:function(e){StaticContext.firstRequestListeners.forEach((function(t){t.success(e)})),StaticContext.firstRequestListeners=[]},app:void 0,route:void 0,toRoute:void 0,fromRoute:void 0,router:void 0};function getRouteByPage(e){var t=e.route||"";return t.startsWith("/")||(t="/"+t),{fullPath:t,path:t}}function warn(e){var t=e.options.debugger;if(t&&(!0===t||t.info)){for(var r,o=arguments.length,n=new Array(o>1?o-1:0),a=1;a<o;a++)n[a-1]=arguments[a];(r=console).warn.apply(r,n)}}function getCurrentPagePath(){var e=getCurrentPage();return e&&e.route?"/"+e.route:void 0}function getCurrentPage(){var e=getCurrentPages();return e.length>0?e[e.length-1]:void 0}function getRouteByPath(e,t,r,o){o=o||formatFullPath(t,r);var n=t.replace(/^\//,""),a=e.routeMap.pathMap[n];return a?_objectSpread(_objectSpread({},a),{},{fullPath:o,path:t,query:r}):{fullPath:o,path:t,query:r}}function getRouteByUrl(e,t){var r,o,n=e.indexOf("?");n>-1?(o=e.substring(0,n),r=e.substring(n+1)):(o=e,r="");var a=r?qs__default.default.parse(r):{},u=o.replace(/^\//,""),i=t.routeMap.pathMap[u];return i?_objectSpread(_objectSpread({},i),{},{fullPath:e,path:o,query:a}):{fullPath:e,path:o,query:a}}function formatFullPath(e,t){var r=qs__default.default.stringify(t);return r?"".concat(e,"?").concat(r):e}function lockNavjump(e,t,r){var o,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a={};if(jsUtils.isString(e))a.url=e;else{var u,i=e,c=i.query;if(i.name){var s=t.routeMap.nameMap,p=s[i.name];u=p.path}else u=i.path,c=i.query;var l=formatFullPath(u,c),f=_objectSpread({},i);delete f.name,delete f.path,delete f.query,Object.assign(a,f),a.url=l}switch(a.$force=n,r){case"push":o=uni.navigateTo(a);break;case"replace":o=uni.redirectTo(a);break;case"pushTab":o=uni.switchTab(a);break;case"replaceAll":o=uni.reLaunch(a);break;default:throw new Error("\u8def\u7531\u7c7b\u578b\u4e0d\u6b63\u786e")}return o}function appendPages(e,t,r){r.forEach((function(r){var o=r.path,n=o.startsWith("/")?o:"/"+o,a=_objectSpread(_objectSpread({},r),{},{path:n});t[n]=a,e.push(a)}))}function parseRoutesFromPages(e){var t=e.pages,r=e.subPackages,o=void 0===r?[]:r,n=[],a={};return appendPages(n,a,t),o.forEach((function(e){appendPages(n,a,e.pages)})),n}function callEachHooks(e,t,r,o){return _callEachHooks.apply(this,arguments)}function _callEachHooks(){return(_callEachHooks=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,r,o,n){var a,u;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.lifeCycleHooks[r],e.next=3,jsUtils.queueInvoke(a,null,[o,n],(function(e){return!1!==e&&!jsUtils.isObject(e)}));case 3:return u=e.sent,e.abrupt("return",u);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function invokeAfterEach(e,t,r){return _invokeAfterEach.apply(this,arguments)}function _invokeAfterEach(){return(_invokeAfterEach=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,r,o){return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,callEachHooks(t,"ae",r,o);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function invokeBeforeEach(e,t,r){return _invokeBeforeEach.apply(this,arguments)}function _invokeBeforeEach(){return(_invokeBeforeEach=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,r,o){var n,a,u,i;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return StaticContext.beforeEachLock=!0,e.prev=1,e.next=4,callEachHooks(t,"be",r,o);case 4:if(!0!==(n=e.sent)&&null!=n){e.next=9;break}return e.abrupt("return",!0);case 9:return!1!==n&&(u="push",jsUtils.isString(n)?(a={path:n},u="push"):jsUtils.isObject(n)&&(a=(i=n).to,u=i.navType),a&&lockNavjump(a,t,u,!0)),e.abrupt("return",!1);case 11:return e.prev=11,StaticContext.beforeEachLock=!1,e.finish(11);case 14:case"end":return e.stop()}}),e,null,[[1,,11,14]])})))).apply(this,arguments)}var IS_WAPPED=!1,METHOD_NAME_NAVIGATE_TO="navigateTo",METHOD_NAME_REDIRECT_TO="redirectTo",METHOD_NAME_RELAUNCH="reLaunch",METHOD_NAME_SWITCH_TAB="switchTab",METHOD_NAME_NAVIGATE_BACK="navigateBack",oldMethods=(_defineProperty(_oldMethods={},METHOD_NAME_NAVIGATE_TO,uni.navigateTo),_defineProperty(_oldMethods,METHOD_NAME_REDIRECT_TO,uni.redirectTo),_defineProperty(_oldMethods,METHOD_NAME_RELAUNCH,uni.reLaunch),_defineProperty(_oldMethods,METHOD_NAME_SWITCH_TAB,uni.switchTab),_defineProperty(_oldMethods,METHOD_NAME_NAVIGATE_BACK,uni.navigateBack),_oldMethods);function callOldMethod(e,t){var r=oldMethods[e];r&&r(t)}function callNavError(e,t,r){t.fail&&t.fail(r),t.complete&&t.complete(),e&&(StaticContext.navLock=!1)}function callNavSuccess(e,t){var r=_objectSpread(_objectSpread({},t),{},{success:function(){var e=arguments;return _asyncToGenerator(_regeneratorRuntime.mark((function r(){return _regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,r.t0=t.success,!r.t0){r.next=5;break}return r.next=5,t.success.apply(t,_toConsumableArray(e));case 5:if(r.prev=5,StaticContext.route=StaticContext.toRoute,StaticContext.lastFullPath=StaticContext.route?StaticContext.route.fullPath:void 0,!StaticContext.router||!StaticContext.toRoute){r.next=12;break}return StaticContext.router.route=StaticContext.route,r.next=12,invokeAfterEach(StaticContext.router,StaticContext.toRoute,StaticContext.fromRoute);case 12:return StaticContext.navLock=!1,r.finish(5);case 14:case"end":return r.stop()}}),r,null,[[0,,5,14]])})))()},fail:function(){var e=arguments;return _asyncToGenerator(_regeneratorRuntime.mark((function r(){var o,n,a;return _regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:for(r.prev=0,o=e.length,n=new Array(o),a=0;a<o;a++)n[a]=e[a];if(console.error(n&&n[0]?n[0].errMsg:""),r.t0=t.fail,!r.t0){r.next=7;break}return r.next=7,t.fail.apply(t,n);case 7:return r.prev=7,StaticContext.navLock=!1,r.finish(7);case 10:case"end":return r.stop()}}),r,null,[[0,,7,10]])})))()},complete:function(){t.complete&&t.complete.apply(t,arguments)}});callOldMethod(e,r)}function createWapper(e){function t(){return(t=_asyncToGenerator(_regeneratorRuntime.mark((function t(r){var o,n,a,u,i,c,s;return _regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!StaticContext.navLock&&!StaticContext.beforeEachLock||r.$force){t.next=3;break}return StaticContext.router&&warn(StaticContext.router,"\u5f53\u524d\u9875\u9762\u6b63\u5728\u5904\u4e8e\u8df3\u8f6c\u72b6\u6001\uff0c\u8bf7\u7a0d\u540e\u518d\u8fdb\u884c\u8df3\u8f6c...."),t.abrupt("return",callNavError(!1,r,"\u5f53\u524d\u9875\u9762\u6b63\u5728\u5904\u4e8e\u8df3\u8f6c\u72b6\u6001\uff0c\u8bf7\u7a0d\u540e\u518d\u8fdb\u884c\u8df3\u8f6c...."));case 3:if(StaticContext.navLock=!0,t.prev=4,StaticContext.router){t.next=7;break}return t.abrupt("return",callNavSuccess(e,r));case 7:return o=StaticContext.router,METHOD_NAME_NAVIGATE_BACK==e?(a=jsUtils.isNumber(r.delta)?r.delta:1,u=getCurrentPages(),i=u.length-a-1,n=i<0?getRouteByUrl(o.indexRouteRule.path,o):getRouteByPage(u[i])):(c=r.url,n=getRouteByUrl(c,o)),s=StaticContext.route,StaticContext.toRoute=n,StaticContext.fromRoute=s,StaticContext.destFullPath=n.fullPath,t.next=15,invokeBeforeEach(o,n,s);case 15:if(t.sent){t.next=18;break}return t.abrupt("return",callNavError(!0,r,"\u8def\u7531\u5b88\u536b\u62e6\u622a"));case 18:return t.abrupt("return",callNavSuccess(e,r));case 21:return t.prev=21,t.t0=t.catch(4),t.abrupt("return",callNavError(!0,r,t.t0));case 24:case"end":return t.stop()}}),t,null,[[4,21]])})))).apply(this,arguments)}return function(e){return t.apply(this,arguments)}}function addNavInterceptor(){IS_WAPPED||(IS_WAPPED=!0,uni.navigateTo=createWapper(METHOD_NAME_NAVIGATE_TO),uni.redirectTo=createWapper(METHOD_NAME_REDIRECT_TO),uni.reLaunch=createWapper(METHOD_NAME_RELAUNCH),uni.switchTab=createWapper(METHOD_NAME_SWITCH_TAB),uni.navigateBack=createWapper(METHOD_NAME_NAVIGATE_BACK))}var DEFAULT_PROXY_METHODS=[UniLifecycleHooks.INIT,UniLifecycleHooks.LOAD,UniLifecycleHooks.SHOW,UniLifecycleHooks.READY],MP_TYPE_PAGE="page";function getRouterData(e){return e.__routerData||(e.__routerData={}),e.__routerData}function getOriHookDataMap(e){var t=getRouterData(e);return t.oriHookDataMap||(t.oriHookDataMap={}),t.oriHookDataMap}function getOriHookData(e,t){var r=getOriHookDataMap(e),o=r[t];return o||(o={oldVal:[]},r[t]=o),o}function invokeOriMethod(e,t,r){var o=(getRouterData(t).oldMethods||{})[e];if(o)return o.apply(t,r)}function invokeOriHooks(e,t,r){var o=getOriHookData(t,e);jsUtils.invoke(o.oldVal,t,r)}function saveOriRoute(e,t){getRouterData(e).oriRoute=t}function getOriRoute(e){var t=getRouterData(e);return t.oriRoute||(t.oriRoute={}),t.oriRoute}function saveCurrRouteByCurrPage(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=getCurrentPage();if(o&&o.route){var n="/"+o.route;saveOriRoute(t,{path:n,query:r});var a=getRouteByPath(e,n,r);e.route=a}}function wapperMethod(e,t,r,o){return wapperFun(e,"method",t,r,o,invokeOriMethod)}function wapperFun(e,t,r,o,n,a){return _wapperFun.apply(this,arguments)}function _wapperFun(){return(_wapperFun=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,r,o,n,a,u){var i,c,s,p,l,f,h,v,d,_,y,k,g,E;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=getRouterData(o),!0!==(i.hookLock||!1)){e.next=10;break}return i.hookListeners||(i.hookListeners=[]),c=new Promise((function(e,t){i.hookListeners.push({success:e,fail:t})})),e.next=7,c;case 7:return e.sent&&(s=u(n,o,a)),e.abrupt("return",s);case 10:if(i.hookLock=!0,e.prev=11,l=getCurrentPagePath(),"hook"!==r||UniLifecycleHooks.INIT!=n&&UniLifecycleHooks.LOAD!=n?f=getOriRoute(o).query||{}:(f=a[0]||{},Object.keys(f).forEach((function(e){var t=f[e];t&&(f[e]=decodeURIComponent(t))})),saveOriRoute(o,{path:l,query:f})),h=!0,!l){e.next=33;break}if(v=formatFullPath(l,f),StaticContext.destFullPath==v){e.next=33;break}return d=getRouteByPath(t,l,f,v),_=StaticContext.route,StaticContext.toRoute=d,StaticContext.fromRoute=_,e.next=24,invokeBeforeEach(t,d,_);case 24:if(!(h=e.sent)){e.next=31;break}return StaticContext.route=d,t.route=d,StaticContext.lastFullPath=v,e.next=31,invokeAfterEach(t,d,_);case 31:e.next=33;break;case 33:if(h&&(p=u(n,o,a)),i.hookListeners){for(y=i.hookListeners,k=0;k<y.length;k++)y[k].success(h);i.hookListeners=[]}e.next=40;break;case 37:if(e.prev=37,e.t0=e.catch(11),i.hookListeners){for(g=i.hookListeners,E=0;E<g.length;E++)g[E].fail(e.t0);i.hookListeners=[]}case 40:return i.hookLock=!1,e.abrupt("return",p);case 42:case"end":return e.stop()}}),e,null,[[11,37]])})))).apply(this,arguments)}function wapperHook(e,t,r,o){return wapperFun(e,"hook",t,r,o,invokeOriHooks)}function wapperUniHooks(e,t,r){return function(){for(var o=arguments.length,n=new Array(o),a=0;a<o;a++)n[a]=arguments[a];wapperHook(e,t,r,n)}}function appendRoutes(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",o=arguments.length>3?arguments[3]:void 0;if(o&&0!=o.length){var n=t.pathMap,a=t.nameMap;o.forEach((function(o){var u=o.alias,i=o.path,c=o.name;if(null==i)throw new Error("\u8bf7\u63d0\u4f9b\u4e00\u4e2a\u5b8c\u6574\u7684\u8def\u7531\u5bf9\u8c61\uff0c\u5305\u62ec\u4ee5\u7edd\u5bf9\u8def\u5f84\u5f00\u59cb\u7684 \u2018path\u2019 \u5b57\u7b26\u4e32 ".concat(JSON.stringify(o)));(n[r+i]=o,c&&(a[c]=o),u)&&(Array.isArray(u)?u.forEach((function(e){n[r+e]=o})):n[r+u]=o);appendRoutes(e,t,o.path,o.children)}))}}function createRouteMap(e,t){var r={pathMap:Object.create(null),nameMap:Object.create(null)};return appendRoutes(e,r,"",t),r}function registerEachHooks(e,t,r){var o=e.lifeCycleHooks[t];o||(o=[],e.lifeCycleHooks[t]=o),o.push(r)}function isPageHook(e){return e.$mpType===MP_TYPE_PAGE}var RouterImpl=function(){function e(t){_classCallCheck(this,e),_defineProperty(this,"proxyMode",void 0),_defineProperty(this,"proxyMethods",void 0),_defineProperty(this,"routes",void 0),_defineProperty(this,"indexRouteRule",void 0),_defineProperty(this,"lifeCycleHooks",{}),_defineProperty(this,"$locked",!1),_defineProperty(this,"options",void 0),_defineProperty(this,"routeMap",void 0),_defineProperty(this,"route",void 0),this.options=t,this.proxyMode=t.proxyMode||"hook",this.proxyMethods=t.proxyMethods||DEFAULT_PROXY_METHODS,this.routes=parseRoutesFromPages(t.pageData),this.indexRouteRule=this.routes[0],this.routeMap=createRouteMap(this,this.routes)}var t;return _createClass(e,[{key:"setupRouter",value:function(e){e.use(this)}},{key:"push",value:function(e){return lockNavjump(e,this,"push")}},{key:"replace",value:function(e){return lockNavjump(e,this,"replace")}},{key:"replaceAll",value:function(e){return lockNavjump(e,this,"replaceAll")}},{key:"pushTab",value:function(e){return lockNavjump(e,this,"pushTab")}},{key:"back",value:function(){var e;return(e=uni).navigateBack.apply(e,arguments)}},{key:"beforeEach",value:function(e){registerEachHooks(this,"be",e)}},{key:"afterEach",value:function(e){registerEachHooks(this,"ae",e)}},{key:"install",value:(t=_asyncToGenerator(_regeneratorRuntime.mark((function e(t){var r,o;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this,StaticContext.app=t,StaticContext.router=r,Object.defineProperty(t.config.globalProperties,"$Router",{get:function(){return r}}),Object.defineProperty(t.config.globalProperties,"$Route",{get:function(){return r.route}}),"hook"===r.proxyMode?o={beforeCreate:function(){if(isPageHook(this)){var e=this;r.proxyMethods.forEach((function(t){var o=getOriHookData(e,t),n=e.$[t]||[],a=Array.isArray(n)?n:[n];o.oldVal=a,o.wapper=wapperUniHooks(r,e,t);var u=[o.wapper],i=u;u.push=function(){var e;return(e=o.oldVal).push.apply(e,arguments),u.length},u.pop=function(){return o.oldVal.pop()},u.shift=function(){return o.oldVal.shift()},u.unshift=function(){var e;return(e=o.oldVal).unshift.apply(e,arguments),u.length},i.splice=function(){var e;return(e=o.oldVal).splice.apply(e,arguments)},u.reverse=function(){return o.oldVal.reverse()},u.sort=function(){return o.oldVal.sort()},o.newVal=u,Object.defineProperty(e.$,t,{get:function(){return o.newVal},set:function(e){e!==o.newVal&&e!==o.wapper&&(e?Array.isArray(e)?e.indexOf(o.wapper)>-1?e.length>1&&e.forEach((function(e){e!==o.wapper&&o.oldVal.push(e)})):o.oldVal=e:o.oldVal=[e]:o.oldVal=[])}})}))}}}:"method"===r.proxyMode&&(o={created:function(){if(isPageHook(this)){var e=this,t=getRouterData(e),o={};t.oldMethods=o,r.proxyMethods.forEach((function(t){var n=e[t];n?(o[t]=n,e[t]=function(){for(var o=arguments.length,n=new Array(o),a=0;a<o;a++)n[a]=arguments[a];return wapperMethod(r,e,t,n)}):console.warn("\u6b64\u9875\u9762\u6ca1\u6709\u65b9\u6cd5:".concat(t))}))}},onInit:function(e){isPageHook(this)&&saveCurrRouteByCurrPage(r,this,e)},onLoad:function(e){isPageHook(this)&&saveCurrRouteByCurrPage(r,this,e)}}),o&&t.mixin(o),addNavInterceptor();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}();function createRouter(e){return new RouterImpl(e)}exports.UniLifecycleHooks=UniLifecycleHooks,exports.createRouter=createRouter;